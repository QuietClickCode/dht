<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>购物车</title>
    <script src="/js/Adaptive.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/new.css">
</head>

<body class="bge6">
<div class="box">
    <div class="specialty-title2">
        <a href="/user/userCenter" class="icon-return"></a>
        <span>购物车</span>
        <a  class="shopping-care-change">
            <span class="text" id="edit-goods-detail">编辑</span>
            <i class="icon-change">
                <span class="number">8</span>
            </i>
        </a>
    </div>

    <div class="care-cont box2">
        <!--<div class="purchase J_product">-->
            <!--<div class="checkbox">-->
                <!--<i class="icon-checkbox J_checkbox goods-item"></i>-->
            <!--</div>-->
            <!--<a href="" class="img-box">-->
                <!--<img src="/img/care-icon6.png" alt="">-->
            <!--</a>-->
            <!--<div class="purchase-text">-->
                <!--<a href="" class="title">-->
                    <!--<span class="label">特价</span>-->
                    <!--2017年秋季新款简约黄色裙子系带显瘦短 2017年秋季新款简约黄色裙子系带显-->
                <!--</a>-->
                <!--<p class="norms J_norms item-detail">颜色:深灰色;尺码:XL;</p>-->
                <!--<div class="price-box">-->
                        <!--<span class="price">￥-->
                            <!--<span class="J_price">22.85</span>-->
                        <!--</span>-->
                    <!--<div class="number-box">-->
                        <!--<i class="icon-reduce J_careReduce"></i>-->
                        <!--<span class="num J_careNum">3</span>-->
                        <!--<i class="icon-add J_careAdd"></i>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->


        <div class="invalid-goods">
            <h1 class="invalid-tittle-box clearfix">
                <span class="invalid-tittle">失效商品</span>
                <button onclick="deleteinvalidatebuycar()" class="clear-all-invalid">清空无效商品</button>
            </h1>

            <!--无失效商品时，展示-->
            <div class="no-invalid-tip" style="display: none">恭喜您！暂无失效商品</div>
        </div>

    </div>

    <!-- 为你推荐 -->
    <div class="like" style="display: none">
        <div class="cont">
            <span>为你推荐</span>
        </div>
    </div>

    <ul class="care-groom box2" style="display: none;">
        <!--<li>-->
            <!--<a href="" class="img">-->
                <!--<img src="/img/care-icon7.jpg" alt="">-->
            <!--</a>-->
            <!--<a href="" class="title">汪氏天然滋补纯正蜂蜜农家自产槐花洋槐枣百花蜂蜜...</a>-->
            <!--<p class="price">￥55</p>-->
        <!--</li>-->


    </ul>



    <!-- 占位盒子 -->
    <div class="placeholder-footer2"></div>
    <div class="care-footer" id="car-total-box">
        <div class="all-checkbox">
            <i class="icon-checkbox J_allCheckbox" id="all-buy-toggle"></i>
            <span>全选</span>
        </div>
        <div class="total">
            合计
            <span class="total-num">
                    ￥
                    <span class="J_totalNum" id="J_totalNum">0.00</span>
                </span>
        </div>
        <a onclick="buynow();" class="settlement">去结算（
            <span class="J_productNum" id="J_productNum">0</span>）</a>
    </div>

</div>

<!-- 遮罩层 -->
<!-- 默认是隐藏的，删除style样式 -->
<div class="mark" id="J_mark" style="display:none;"></div>
<!-- 规格选择 -->
<!-- 默认是隐藏的，删除style样式 -->
<div class="care-norms-checkbox J_careNormsCheckbox" style="display:none;">
    <i class="care-norms-close J_careNormsClose"></i>
    <div class="product">
        <img id="gsimg" src="/img/list2.jpg" alt="">
        <div class="text">
            <!--<p id="current-edit-price">￥168.00</p>-->
            <p id="current-edit-price"></p>
            <span id="inventoryspan">库存60件</span>
        </div>
    </div>
    <div id="gsdiv">
        <div class="care-checkbox J_careCheckbox">
            <span class="name">颜色</span>
            <div class="clearfix shop-car-color">
                <span class="checkbox active J_checkbox">卡其色</span>
                <span class="checkbox J_checkbox">灰色</span>
            </div>
        </div>
    </div>

    <div class="care-checkbox" style="margin-top: 10px">
        <span class="name">数量</span>
        <div class="number number-box">
            <span class="reduce J_careReduce" id="gsreducebtn">-</span>
            <span class="num J_careNum" id="current-num"></span>
            <span class="add J_careAdd" id="gsaddbtn">+</span>
        </div>
    </div>
    <a onclick="suregsa()" id="setgsvala" class="care-norms-checkbox-btn">确定</a>
</div>

<!-- 删除提示 -->
<div class="footprint-prompt" id="J_footprintPrompt">
    <!--<p> 确定将这1个宝贝删除？</p>-->
    <p id="del-goods-notice"></p>
    <div class="footprint-confirm">
        <span class="cancel" id="J_cancel">取消</span>
        <span class="confirm" id="J_confirm">确定</span>
    </div>
</div>

<!-- 删除全选 -->
<div class="care-footer" id="del-goods-box" style="display: none;">
    <div class="all-checkbox">
        <i class="icon-checkbox J_allCheckbox" id="all-del-toggle"></i>
        <span>全选</span>
    </div>
    <div class="total">
    </div>
    <a href="javascript: ;" class="close-all">删除</a>
</div>

<form method="post" action="/order/getCheckOrderData" style="display: none" id="checkorderdataform">
    <input type="hidden" id="checkorderdata" name="data">
</form>

<script src="/js/jquery-1.9.1.min.js"></script>
<script src="/js/jquery.lazyload.js?v=1.9.1"></script>
<script src="/js/layer/layer.js"></script>
<!--页面交互-->
<script>
    var totolPriceBox = $('#J_totalNum');   //购物车里边勾选的商品总价
    var totolNumBox = $('#J_productNum');   //购物车里边勾选的商品总数量
    var totolPrice = 0;  //总价
    var totolNum = 0;    //勾选总数
    var recordItemSelected = [];    //点击编辑同时记录之前选择的选择下标

    //购物车全选购买交互
    function toCalculateTotal() {
        $('#all-buy-toggle')[0].onclick = function () {
            var goodsList = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
            var isAllBug = $($('#all-buy-toggle')[0]).hasClass('active'); //是否全选按钮
            if(isAllBug){
                //当前为全选
                for(var i=0; i<goodsList.length; i++){
                    $(goodsList[i]).removeClass('active')
                }
                $($('#all-buy-toggle')[0]).removeClass('active');
                totolPriceBox.html(0);   //将新运算的总价及总数量放入
                totolNumBox.html(0);
            }else {
                //当前为全不选
                for(var i=0; i<goodsList.length; i++){
                    $(goodsList[i]).addClass('active')
                }
                $($('#all-buy-toggle')[0]).addClass('active');
                totolPrice =0;   //点击之前将之前的数据置空
                totolNum =0;
                toCalculateTotalPrice();
                totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                totolNumBox.html(totolNum);
            }
        }
    }

    //每一个商品项被点击，购物车总价以及数量刷新数据
    function toRefrechTotalPrice() {
        var goodsItems = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
        for(var i=0; i<goodsItems.length; i++){
            goodsItems[i].onclick = function () {
                if($(this).hasClass('active')){
                    $(this).removeClass('active')
                }else {
                    $(this).addClass('active')
                }
                totolPrice =0;   //点击之前将之前的数据置空
                totolNum =0;
                toCalculateTotalPrice();
                totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                totolNumBox.html(totolNum);

                //如果商品勾选数量与商品数量不相等，取消全选，相等的话加上全选
                var goodsSelectedItems = $('.care-cont').find('.active');
                if(goodsItems.length == goodsSelectedItems.length){
                    $($('#all-buy-toggle')[0]).addClass('active');
                    totolPrice =0;   //点击之前将之前的数据置空
                    totolNum =0;
                    toCalculateTotalPrice();
                    totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                    totolNumBox.html(totolNum);
                }else {
                    $($('#all-buy-toggle')[0]).removeClass('active');
                }
            }
        }
    }

    //计算当前勾选商品的总价以及数量
    function toCalculateTotalPrice() {
        var goodsList = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
        for(var i=0; i<goodsList.length; i++){
            var isChecked = $(goodsList[i]).hasClass('active');
            if(isChecked){
                totolPrice += $(goodsList[i].parentNode.parentNode).find('.J_price')[0].innerHTML * $(goodsList[i].parentNode.parentNode).find('.J_careNum')[0].innerHTML;
                totolNum += parseInt($(goodsList[i].parentNode.parentNode).find('.J_careNum')[0].innerHTML);
            }
        }
    }

    //每件商品数量增减
    function changeGoodsNum() {
        var reduceItemNum = $('.icon-reduce');
        var addItemNum = $('.icon-add');

        toNumCanNotReduce(reduceItemNum, addItemNum, true);
    }

    //编辑商品详情
    function editGoodsDetailBtn() {
        var editGoodsDetailBtn = $('#edit-goods-detail')[0];  //编辑按钮
        var editItemGoodBtns = $('.item-detail');  //编辑按钮

        editGoodsDetailBtn.onclick = function () {
            var goodsList = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
            if(this.innerHTML == '编辑'){
                recordItemSelected = [];
                this.innerHTML = '完成';
                for(var i=0; i<editItemGoodBtns.length; i++){
                    $(editItemGoodBtns[i]).addClass('change');
                }
                //把之前购物车的选中index记录到recordItemSelected数组
                for(var j=0; j<goodsList.length; j++){
                    if($(goodsList[j]).hasClass('active')){
                        recordItemSelected.push(j)
                    }
                    $(goodsList[j]).removeClass('active')
                }
                //隐藏购物车，显示全部删除
                $($('#car-total-box')[0]).hide();
                $($('#del-goods-box')[0]).show();

//                console.log($('.care-cont').find('.change'));
                toEachGoodsChangeDetail(true);
                editStatus();
                editStatusItemsChangeAllChoose();
                delCarGoodsItems();
            }else{
                this.innerHTML = '编辑';
                for(var i=0; i<editItemGoodBtns.length; i++){
                    $(editItemGoodBtns[i]).removeClass('change');
//                    $(editItemGoodBtns[i]).unbind('click');
                }
                for(var j=0; j<goodsList.length; j++){
                    $(goodsList[j]).removeClass('active');
                    for(var k=0; k<recordItemSelected.length; k++){
                        $(goodsList[recordItemSelected[k]]).addClass('active')
                    }
                }

//                console.log($('.care-cont').find('.change'));
                //隐藏全部删除，显示购物车
                $($('#del-goods-box')[0]).hide();
                $($('#car-total-box')[0]).show();


                toEachGoodsChangeDetail(false);

                //将全选按钮高亮状态删去
                $('#all-del-toggle').removeClass('active');

                //从新计算当前的总价以及总数量
                totolPrice =0;   //点击之前将之前的数据置空
                totolNum =0;
                toCalculateTotalPrice();
                totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                totolNumBox.html(totolNum);

                //从新执行每个选项是否勾选改变购物车总计以及总数量
                toRefrechTotalPrice();

            }
        }
    }

    //每一个商品项，点击编辑，显示对应编辑遮罩层以及交互
    function toEachGoodsChangeDetail(b) {
        var closeGoodsDetail = $('.J_careNormsClose')[0]; //所有的点击编辑按钮
        var shopCarColorWrap = $('.shop-car-color')[0]; //购物车颜色包裹
        var shopCarSizeWrap = $('.size-box')[0]; //购物车尺寸包裹
        var changeItems = $('.item-detail'); //

        if(b){
            for(var i=0; i<changeItems.length; i++){
                $(changeItems[i]).bind('click', function (){
                    var colorList = '';
                    var sizeList = '';
//                颜色和尺寸应该是从后台获取，但是价格和当前选择的数量可以从列表传过来
                    var color = ['卡其色', '黑色', '灰色', '深灰色'];  //模拟颜色
                    var size = ['S', 'M', 'L', 'XL', 'XXL'];  //模拟尺寸
                    var thisColor = this.innerHTML.split(';')[0].substr(3); //截取当前颜色
                    var thisSize = this.innerHTML.split(',')[1].substr(3); //截取当前尺寸

                    //获取后的颜色插入到遮罩层
                    for(var i=0; i<color.length; i++){

                        if(color[i] == thisColor){
                            colorList += '<span class="checkbox current-item-color active J_checkbox">'+ thisColor +'</span>'
                        }else{
                            colorList += '<span class="checkbox current-item-color J_checkbox">'+ color[i] +'</span>'
                        }

                    }
                    $(shopCarColorWrap).append(colorList);

                    //获取后的大小插入到遮罩层
                    for(var j=0; j<size.length; j++){
                        if(size[j] == thisSize){
                            sizeList += '<span class="checkbox current-item-size active J_checkbox">'+ thisSize +'</span>'
                        }else{
                            sizeList += '<span class="checkbox current-item-size J_checkbox">'+ size[j] +'</span>'
                        }
                    }
                    $(shopCarSizeWrap).append(sizeList);

                    //获取当前价格，插入并改变对应项遮罩层价格
                    $('#current-edit-price').html('￥' + $(this).parent().parent().find('.J_price').html());

                    //获取当前商品的数量，插入并改变对应项遮罩层数量
                    $('#current-num').html($(this).parent().parent().find('.J_careNum').html());

                    //数量等于1的时候，减少按钮置灰
                    //autoJudgeCanReduce();

                    //遮罩层显示打开
                    $('.J_careNormsCheckbox,#J_mark').show();

                    //颜色以及大小可以改变交互
                    toChangeCurrentColorSize();

                    //编辑完成点击确定，将用户改变的颜色，大小，数量传递回对应的商品项
                    confirmEditItemDtail(this);
                })
            }
        }else {
            for(var j=0; j<changeItems.length; j++){
                $(changeItems[j]).unbind('click')
            }
        }

        closeGoodsDetail.onclick = function () {
            $('.J_careNormsCheckbox,#J_mark').hide();
            $(shopCarColorWrap).html('');
            $(shopCarSizeWrap).html('');

            //清空遮罩层对应商品的价格
            $('#current-edit-price').html();

            //清空遮罩层对应商品的数量
            $('#current-num').html();
        }
    }

    //编辑状态，全选交互
    function editStatus() {
        var goodsList = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
        $('#all-del-toggle')[0].onclick = function () {
            if($(this).hasClass('active')){
                for(var i=0; i<goodsList.length; i++){
                    $(goodsList[i]).removeClass('active')
                }
                $(this).removeClass('active');
            }else{
                for(var j=0; j<goodsList.length; j++){
                    $(goodsList[j]).addClass('active')
                }
                $(this).addClass('active');
            }
        }
    }

    //编辑状态，一个不选择情况下，取消全选；全部逐个选中，全选按钮显示全选
    function editStatusItemsChangeAllChoose() {
        var goodsList = $('.goods-item');   //已经在购物车里边的商品列表(全局变量)
        for(var i=0; i<goodsList.length; i++){
            goodsList[i].onclick = function () {
                if($(this).hasClass('active')){
                    $(this).removeClass('active')
                }else {
                    $(this).addClass('active')
                }
                //如果商品勾选数量与商品数量不相等，取消全选，相等的话加上全选
                var goodsDelSelectedItems = $('.care-cont').find('.active');
                if(goodsList.length == goodsDelSelectedItems.length){
                    $($('#all-del-toggle')[0]).addClass('active');
                }else {
                    $($('#all-del-toggle')[0]).removeClass('active');
                }
            }
        }
    }

    //编辑状态，点击删除，展示遮罩层提示，并根据用户确认选择，是否删除勾选项
    function delCarGoodsItems() {
        $('.close-all')[0].onclick = function () {
            if($('.care-cont').find('.active').length == 0){
                $('#del-goods-notice').html('对不起！您暂未勾选删除项');
                $('#J_mark,#J_footprintPrompt').show()
            }else {
                $('#del-goods-notice').html('确定将您选择的宝贝删除？');
                $('#J_mark,#J_footprintPrompt').show();
            }
        };

        //取消删除项
        $('#J_cancel')[0].onclick = function () {
            $('#J_mark,#J_footprintPrompt').hide()
        };

        //用户确认要删除勾选的删除项
        $('#J_confirm')[0].onclick = function () {
            //找到当前勾选的删除项
            var goodsDelSelectedItems = $('.care-cont').find('.active');
            var deleteBcids='';
            for(var i=0; i<goodsDelSelectedItems.length; i++){
                deleteBcids+=','+$(goodsDelSelectedItems[i]).find('input')[0].value;
            }
            deleteBcids=deleteBcids.substr(1);
            $.ajax({
                type:"post",
                url:'/buyCar/deleteBuyCar',
                dataType: "json",
                async :false,
                data:{buyCarIds:deleteBcids},
                success:function(data){
                    if(data.status==0){
                        window.location.href='/buyCar/gotoShoppingCar';
                    }else{
                        layer.msg(data.msg);
                    }
                }
            });
            //关闭遮罩层
            $('#J_mark,#J_footprintPrompt').hide()
        }
    }

    //编辑状态,对应遮罩层改变他的颜色，以及大小,以及对应商品的数量
    function toChangeCurrentColorSize() {
        var currentItemColor = $('.current-item-color'); //当前编辑商品项的颜色列表
        var currentItemSize = $('.current-item-size'); //当前编辑商品项的大小列表
        var currentItemNum = $('#current-num'); //当前编辑商品项的数量
        var currentItemNumValue = parseInt($('#current-num').html()); //当前编辑商品项的数量值

        //点击当前颜色改变改变状态，同时其他颜色移除选中状态
        for(var i=0; i<currentItemColor.length; i++){
            currentItemColor[i].onclick = function () {
                $(this).addClass('active').siblings().removeClass('active');
            }
        }

        //点击当前尺寸改变改变状态，同时其他大小移除选中状态
        for(var j=0; j<currentItemSize.length; j++){
            currentItemSize[j].onclick = function () {
                $(this).addClass('active').siblings().removeClass('active');
            }
        }

        //toNumCanNotReduce(currentItemNum.parent().find('.J_careReduce'), currentItemNum.parent().find('.J_careAdd'), false)
    }

    //公用的，数量按钮减到1，给按钮添加class，数量在2或以上就移除该class
    function toNumCanNotReduce(r, a, calculate) {

        //减少当前商品的数量
        for(var i=0; i<r.length; i++){
            r[i].onclick = function () {
                var reduceNum = $(this).parent().find('.J_careNum').html();
                reduceNum--;

                if(parseInt($(this).parent().find('.J_careNum').html()) <= 2){
                    $(this).parent().find('.J_careNum').html(1);
                    $($(this).parent().find('.J_careNum').parent().find('.J_careReduce')[0]).addClass('forbidden-reduce')
                }else {
                    $(this).parent().find('.J_careNum').html(reduceNum);
                }

                //如果要计算总价
                if(calculate){
                    totolPrice =0;   //点击之前将之前的数据置空
                    totolNum =0;
                    toCalculateTotalPrice();
                    totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                    totolNumBox.html(totolNum);
                }
            }
        }


        //增加当前商品的数量

        for(var j=0; j<a.length; j++){
            a[j].onclick = function () {
                var reduceNum = $(this).parent().find('.J_careNum').html();
                reduceNum++;

                if(parseInt($(this).parent().find('.J_careNum').html()) > 0 ){
                    $(this).parent().find('.J_careNum').html(reduceNum);
                    $($(this).parent().find('.J_careNum').parent().find('.J_careReduce')[0]).removeClass('forbidden-reduce')
                }else {
                    $(this).parent().find('.J_careNum').html(reduceNum);
                }

                //如果要计算总价
                if(calculate){
                    totolPrice =0;   //点击之前将之前的数据置空
                    totolNum =0;
                    toCalculateTotalPrice();
                    totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
                    totolNumBox.html(totolNum);
                }
            }
        }

    }

    //编辑状态,编辑完成点击确定，将用户改变的颜色，大小，数量传递回对应的商品项
    function confirmEditItemDtail(o){
        var editCurrentNum = $('#current-num').html(); //选中的商品数量
        var editCurrentComfirmBtn = $('.care-norms-checkbox-btn')[0]; //编辑完成确定按钮

        var shopCarColorWrap = $('.shop-car-color')[0]; //购物车颜色包裹
        var shopCarSizeWrap = $('.size-box')[0]; //购物车尺寸包裹

//        editCurrentComfirmBtn.onclick = function () {
//            $(o)[0].innerHTML = '颜色:' + $('.shop-car-color').find('.active').html() + ';尺码:' + $('.size-box').find('.active').html() + ';';;
//            $(o).parent().parent().find('.J_careNum').html($('#current-num').html());
//
//            //将遮罩层的颜色列表和尺寸列表清空
//            $(shopCarColorWrap).html('');
//            $(shopCarSizeWrap).html('');
//
//            //关闭遮罩层
//            //$('.J_careNormsCheckbox,#J_mark').hide();
//
//            //编辑确定后再次判断数量是否为1
////            debugger;
//            autoJudgeCanReduce();
//        }

    }

    //列表加载出来，判断列表项的数量状态为1，为当前项的减号添加class（forbidden-reduce）
    function autoJudgeCanReduce() {
        var careNumList = $('.J_careNum');

        for(var i=0; i<careNumList.length; i++){
            if(parseInt($(careNumList[i]).html()) === 1){
                $(careNumList[i]).parent().find('.J_careReduce').addClass('forbidden-reduce')
            }else {
                $(careNumList[i]).parent().find('.J_careReduce').removeClass('forbidden-reduce')
            }
        }
    }

    //清空无效商品
    function clearInvalidGoods() {
        var invalidGoods = $('.invalid-goods').find('.J_product');  //无效商品列表
        var clearInvalidBtn = $('.invalid-goods').find('.clear-all-invalid');  //清空无效商品按钮

        //点击清楚失效商品
//        clearInvalidBtn[0].onclick = function () {
//            for(var i=0; i<invalidGoods.length; i++){
//                $(invalidGoods[i]).remove()
//            }
//
//            $(clearInvalidBtn).addClass('clear-disable');
//            $('.no-invalid-tip').show()
//        };

        //页面加载自动判断是否有失效商品，给button设置样式
//        if(invalidGoods.length < 1){
//            $(clearInvalidBtn).addClass('clear-disable');
//            $('.no-invalid-tip').show()
//        }
    }


    //    window.onload = function () {
    //        autoJudgeCanReduce();
    //        toCalculateTotal();
    //        toRefrechTotalPrice();
    //        changeGoodsNum();
    //        editGoodsDetailBtn();
    //        clearInvalidGoods();
    //    }

    function init() {
//        //autoJudgeCanReduce();
        toCalculateTotal();
        toRefrechTotalPrice();
//        changeGoodsNum();
        editGoodsDetailBtn();
        clearInvalidGoods();
    }

</script>

<!--定义函数-->
<script>
    var pageNo=1;
    var pageSize=10;
    <!--加载购物车数据-->
    function loadbuycardata() {
        $.ajax({
            type:"post",
            url:'/buyCar/queryBuyCarList',
            dataType: "json",
            async:false,
            data:{isPutway:1,pageNo:pageNo,pageSize:pageSize},
            success:function(data){
                var rows = data.rows;
                if(rows!=null&&rows.length>0){
                    var html = '';
                    var nogoodsdiv=$($('.invalid-goods')[0]);
                    nogoodsdiv.siblings().remove();
                    for(var i=0;i<rows.length;i++){
                        html = '<div class="purchase J_product">'+
                            '<div class="checkbox">'+
                            '<i class="icon-checkbox J_checkbox goods-item"><input type="hidden" value="'+rows[i].bcId+'"></i>' +
                            '<input type="hidden" name="gdId" value="'+rows[i].gdId+'"/>' +
                            '<input type="hidden" name="bcDescription" value="'+rows[i].bcDescription+'"/>' +
                            '</div>';
                        var goodsPath;
                        var gdImgurl = rows[i].gdimgurl;
                        var imgUrl = rows[i].imgUrl;
                        var flag1 = gdImgurl.substr(gdImgurl.length-4)=="null";
                        if(!flag1){
                            goodsPath = gdImgurl;
                        }else{
                            goodsPath = imgUrl;
                        }
                        html += '<a href="/goods/'+rows[i].gid+'.html" class="img-box">'+
                            '<img data-original="'+goodsPath+'" alt="">'+
                            '</a>'+
                            '<div class="purchase-text">'+
                            '<a href="/goods/'+rows[i].gid+'.html" class="title">'+
                            rows[i].gname+
                        '</a>' +
                            '<input value="'+rows[i].bcGsvalids+'" type="hidden">'+
                        '<p onclick="showgsmodal('+rows[i].bcId+','+rows[i].gid+',\''+rows[i].bcGsvalids+'\',\''+goodsPath+'\',this)" class="norms J_norms item-detail">'+rows[i].bcGsval+'</p>'+
                        '<div class="price-box">'+
                            '<span class="price">￥'+
                            '<span class="J_price">'+parseFloat(rows[i].gdPrice/100).toFixed(2) +'</span>'+'/'+rows[i].gunitname+
                            '</span>'+
                            '<div class="number-box">';
                        var gstartbuy = rows[i].gstartbuy;
                        var gendbuy = rows[i].gendbuy;
                        var gcount = rows[i].gcount;
                        var isMultiplebuy = rows[i].isMultiplebuy;
                        var inventory = rows[i].inventory;
                        //alert('gcount:'+gcount+',inventory:'+inventory);
                        var number=0;
                        if(gcount>inventory){
                            number=inventory;
                        }else{
                            number=gcount;
                        }
                        html += '<i class="icon-reduce J_careReduce" onclick="pdmaxinventory(\'-\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+inventory+',this,'+rows[i].bcId+')"></i>'+
                            '<span class="num J_careNum">'+number+'</span>'+
                            '<i class="icon-add J_careAdd" onclick="pdmaxinventory(\'+\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+inventory+',this,'+rows[i].bcId+')"></i>'+
                            '</div>'+
                            '</div>'+
                            '</div>'+
                            '</div>';
                        nogoodsdiv.before(html);
                    }
                    $("img").lazyload({effect: "fadeIn"});
                    init();
                    if(rows.length<5){
                        flag = false;
                        loadinvalidategoods();
                    }else{
                        flag = true;
                        pageNo++;
                        scrollbuycar();
                    }
                }else{
                    loadinvalidategoods();
                }
            }
        });
    }

    var flag = false;
    <!--滚动加载购物车-->
    function scrollbuycar() {
        $(document).ready(function(){
            var range = 50;             //距下边界长度/单位px
            var totalheight = 0;
            var main = $($('.invalid-goods')[0]);                     //主体元素
            $(window).scroll(function(){
                var srollPos = $(window).scrollTop();    //滚动条距顶部距离(页面超出窗口的高度)

                totalheight = parseFloat($(window).height()) + parseFloat(srollPos);

                if(($(document).height()-range) <= totalheight && flag) {
                    flag = false;
                    $.ajax({
                        type:"post",
                        url:'/buyCar/queryBuyCarList',
                        dataType: "json",
                        async :false,
                        data:{isPutway:1,pageNo:pageNo,pageSize:pageSize},
                        success:function(data){
                            var rows = data.rows;
                            if(rows!=null&&rows.length>0){
                                for(var i=0;i<rows.length;i++){
                                    html = '<div class="purchase J_product">'+
                                        '<div class="checkbox">'+
                                        '<i class="icon-checkbox J_checkbox goods-item"></i>'+
                                        '<input type="hidden" name="gdId" value="'+rows[i].gdId+'"/>'+
                                        '</div>';
                                    var goodsPath;
                                    var gdImgurl = rows[i].gdimgurl;
                                    var imgUrl = rows[i].imgUrl;
                                    var flag1 = gdImgurl.substr(gdImgurl.length-4)=="null";
                                    if(!flag1){
                                        goodsPath = gdImgurl;
                                    }else{
                                        goodsPath = imgUrl;
                                    }
                                    html += '<a href="/goods/'+rows[i].gid+'.html" class="img-box">'+
                                        '<img data-original="'+goodsPath+'" alt="">'+
                                        '</a>'+
                                        '<div class="purchase-text">'+
                                        '<a href="/goods/'+rows[i].gid+'.html" class="title">'+
                                        rows[i].gname+
                                        '</a>' +
                                        '<input value="'+rows[i].bcGsvalids+'" type="hidden">'+
                                        '<p onclick="showgsmodal('+rows[i].bcId+','+rows[i].gid+',\''+rows[i].bcGsvalids+'\',\''+goodsPath+'\',this)" class="norms J_norms item-detail">'+rows[i].bcGsval+'</p>'+
                                        '<div class="price-box">'+
                                        '<span class="price">￥'+
                                        '<span class="J_price">'+parseFloat(rows[i].gdPrice/100).toFixed(2) +'</span>'+'/'+rows[i].gunitname+
                                        '</span>'+
                                        '<div class="number-box">';
                                    var gstartbuy = rows[i].gstartbuy;
                                    var gendbuy = rows[i].gendbuy;
                                    var gcount = rows[i].gcount;
                                    var isMultiplebuy = rows[i].isMultiplebuy;
                                    var inventory = rows[i].inventory;
                                    //alert('gcount:'+gcount+',inventory:'+inventory);
                                    var number=0;
                                    if(gcount>inventory){
                                        number=inventory;
                                    }else{
                                        number=gcount;
                                    }
                                    html += '<i class="icon-reduce J_careReduce" onclick="pdmaxinventory(\'-\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+inventory+',this,'+rows[i].bcId+')"></i>'+
                                        '<span class="num J_careNum">'+number+'</span>'+
                                        '<i class="icon-add J_careAdd" onclick="pdmaxinventory(\'+\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+inventory+',this,'+rows[i].bcId+')"></i>'+
                                        '</div>'+
                                        '</div>'+
                                        '</div>'+
                                        '</div>';
                                    main.before(html);
                                }
                                $("img").lazyload({effect: "fadeIn"});
                                init();
                                pageNo++;
                                flag = true;
                            }else{
                                <!--加载失效商品-->
                                pageNo=1;
                                loadinvalidategoods();
                            }
                        }
                    });

                }
            });
        });
    }

    function pdmaxinventory(ysf,gstartbuy,gendbuy,isMultiplebuy,inventory,obj,bcid) {
        var goodsnumber;
        var numspan;
        if(ysf=='+'){
            numspan = $(obj).prev();
            goodsnumber = parseInt(numspan.html());
        }else{
            numspan = $(obj).next();
            goodsnumber = parseInt(numspan.html());
        }

        if(isMultiplebuy==1){
            if(ysf=='+'){
                if(goodsnumber+gstartbuy>gendbuy){
                    goodsnumber=gendbuy;
                    numspan.html(gendbuy);
                }else{
                    goodsnumber=goodsnumber+gstartbuy;
                    numspan.html(goodsnumber+gstartbuy);
                }
            }else{
                if(goodsnumber<=gstartbuy){
                    goodsnumber=gstartbuy;
                    numspan.html(gstartbuy);
                }else{
                    goodsnumber=goodsnumber-gstartbuy;
                    numspan.html(goodsnumber-gstartbuy);
                }

            }
        }else{
            if(ysf=='+'){
                goodsnumber++;
            }else{
                goodsnumber--;
                if(goodsnumber<=0){
                    goodsnumber=1;
                }
            }
        }



        if(goodsnumber>=gendbuy&&gendbuy!=null){
            layer.msg("最大购买"+gendbuy);
            goodsnumber=gendbuy;
            numspan.html(gendbuy);

        }
        if(goodsnumber<=gstartbuy&&gstartbuy!=null){
            layer.msg("最少购买"+gstartbuy);
            numspan.html(gstartbuy);
            goodsnumber=gstartbuy;
        }
        if(goodsnumber>=inventory){
            layer.msg("必须小于库存量"+inventory);
            numspan.html(inventory);
            goodsnumber=inventory;
        }
        numspan.html(goodsnumber);

        <!--计算总价-->
        totolPrice =0;   //点击之前将之前的数据置空
        totolNum =0;
        toCalculateTotalPrice();
        totolPriceBox.html(totolPrice.toFixed(2));   //将新运算的总价及总数量放入
        totolNumBox.html(totolNum);

        $.ajax({
            type:"post",
            url:"/buyCar/updateBuyCar",
            dataType: "json",
            data:{gcount:goodsnumber,bcId:bcid},
            success:function(data){

            }
        });
    }

    var gstartbuy;
    var gendbuy;
    var isMultiplebuy;
    var bcId;
    var globelInput;
    function showgsmodal(bcId1,gid,hasgsvalids,goodsPath,obj) {
        globelInput = $($(obj).parent().siblings()[0]).find('input[name=gdId]')[0];
        bcId=bcId1;
        if(!$(obj).hasClass('change')){
            return;
        }
        $.ajax({
            type:"post",
            url:'/goodsConfig/queryGoodsConfigBygid',
            dataType: "json",
            async:false,
            data:{gid:gid,pageNo:1,pageSize:2},
            success:function(data){
                var goodsConfig = data.goodsConfig;
                if(goodsConfig!=null){
                    gstartbuy = goodsConfig.gstartbuy;
                    gendbuy = goodsConfig.gendbuy;
                    isMultiplebuy = goodsConfig.isMultiplebuy;
                }

            }
        });

        $.ajax({
            type:"post",
            url:'/goodsGgsrel/queryGgsrelListsOnce',
            dataType: "json",
            async:false,
            data:{gid:gid},
            success:function(data){
                var rows = data.rows;
                if(rows!=null){
                    var gsvalArr = new Array();
                    for(var i=0;i<rows.length;i++){
                        var gsvids = rows[i].gsvidstr.split(' ');
                        var gsvvals = rows[i].gsvvalstr.split(' ');
                        var selectedgsvids = null;
                        if(rows[i].selectedgsvidstr!=null&&rows[i].selectedgsvidstr.length>0){
                            selectedgsvids = rows[i].selectedgsvidstr.split(' ');
                            var str = '';
                            var index = 0;
                            for(var j=0;j<selectedgsvids.length;j++){
                                for(var k=0;k<gsvids.length;k++){
                                    if(selectedgsvids[j]==gsvids[k]){
                                        str += ','+gsvids[k]+':'+gsvvals[k];
                                        index++;
                                    }
                                }
                            }
                            if(index != 0){
                                str = str.substr(1);
                                str = rows[i].gsname+'_'+str;
                                gsvalArr.push(str);
                            }
                        }
                    }

                    if(gsvalArr!=null && gsvalArr.length>0){
                        $('#gsdiv').html('');
                        var html = '';
                        for(var i=0;i<gsvalArr.length;i++){
                            var gsname = gsvalArr[i].split('_')[0];
                            var gsvalidnames = gsvalArr[i].split('_')[1].split(',');
                            html = '<div class="care-checkbox J_careCheckbox" name="gsdivs">'+
                                '<span class="name">'+gsname+'</span>';
                            for(var j=0;j<gsvalidnames.length;j++){
                                var gsvalid = gsvalidnames[j].split(':')[0];
                                var gsvalname = gsvalidnames[j].split(':')[1];
                                var activeclass = '';
                                var hasgsvalidsArr = hasgsvalids.split(' ');
                                for(var k=0;k<hasgsvalidsArr.length;k++){
                                    if(hasgsvalidsArr[k]==gsvalid){
                                        activeclass = 'active';
                                        break;
                                    }
                                }

                                html += '<span class="checkbox_service '+activeclass+'" onclick="clickactive('+gid+',this,\''+goodsPath+'\')"><input value="'+gsvalid+'" type="hidden">'+gsvalname+'</span>&nbsp;';
                            }
                            html += '</div>';
                            $('#gsdiv').append(html);
                        }
                        $('.J_careNormsCheckbox,#J_mark').show();
                    }
                }
                clickactive(gid,null,goodsPath);
            }
        });


    }

    function clickactive(gid,obj,goodsPath) {
        if(obj!=null){
            $(obj).siblings().removeClass('active');
            $(obj).addClass('active');
        }
        loadgavalmessage(gid,goodsPath);
    }

    var canbuy;
    var ginventory;
    <!--点击规格加载信息-->
    function loadgavalmessage(gid,goodsPath) {
        var gsdivs = $('#gsdiv').find('div[name=gsdivs]');
        var gsvalactive = $('#gsdiv').find('.active');

        if(gsdivs.length==gsvalactive.length){
            var gsvids = '';
            for(var i=0;i<gsvalactive.length;i++){
                gsvids += ','+$(gsvalactive[i]).find('input')[0].value;
            }
            gsvids = gsvids.substr(1);
            $.ajax({
                type:"post",
                url:'/goodsDetail/queryGoodsDetailVoLists',
                dataType: "json",
                async :false,
                data:{gid:gid,gsvalIds:gsvids},
                success:function(data){
                    var row = data.row;
                    if(row!=null){
                        var imgUrl = row.imgUrl;
                        var price = parseFloat( row.gdPrice/100).toFixed(2);
                        var inventory = row.gdResidueinventory;
                        var gunitname = row.gunitname;

                        var img = $('#gsimg')[0];
                        var pricespan = $('#current-edit-price')[0];
                        var inventoryspan = $('#inventoryspan')[0];

                        if(imgUrl.substring(imgUrl.length-4,imgUrl.length)=='null'){
                            img.src = goodsPath;
                        }else{
                            img.src = imgUrl;
                        }

                        if(inventory<=0){
                            //把按钮全部变为灰色
                            $('#setgsvala').css('background','#999');
                            canbuy = 0;
                        }else{
                            $('#setgsvala').css('background','');
                            canbuy = 1;
                        }

                        $(pricespan).html('￥'+price+'/'+gunitname);
                        $(inventoryspan).html('库存'+inventory+gunitname);
                        ginventory = inventory;

                        var reducehtml='<span class="reduce J_careReduce" id="gsreducebtn" onclick="pdmaxinventory(\'-\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+ginventory+',this,'+bcId+')">-</span>';
                        var addhtml='<span class="add J_careAdd" id="gsaddbtn" onclick="pdmaxinventory(\'+\','+gstartbuy+','+gendbuy+','+isMultiplebuy+','+ginventory+',this,'+bcId+')">+</span>';
                        $('#current-num').prev().remove();
                        $('#current-num').next().remove();

                        $('#current-num').before(reducehtml);
                        $('#current-num').after(addhtml);
                    }
                }
            });
        }
    }

    <!--确定规格-->
    function suregsa() {
        if(canbuy==0){
            layer.msg('库存不足');
            return;
        }
        var actives = $('#gsdiv').find('.active');
        var gsdivs = $('#gsdiv').find('div[name=gsdivs]');
        if(actives.length>0&&actives.length==gsdivs.length){
            var gsvalid = '';
            var gsval = '';
            for(var i=0;i<actives.length;i++){
                gsvalid += ' '+$(actives[i]).find('input[type=hidden]')[0].value;
                var gsname = $($(actives[i]).siblings()[0]).html()
                gsval += ','+gsname+':'+removeHTMLTag($(actives[i]).html());
            }
            gsvalid = gsvalid.substr(1);
            gsval = gsval.substr(1);
            var gcount = $('#current-num').html();
            $.ajax({
                type:"post",
                url:"/buyCar/updateBuyCar",
                dataType: "json",
                data:{bcGsvalids:gsvalid,bcGsval:gsval,gcount:gcount,bcId:bcId},
                success:function(data){
                    if(data.status==0){
                        window.location.href='/buyCar/gotoShoppingCar';
                    }else{
                        layer.msg(data.msg);
                    }
                }
            });
        }else{
            layer.msg("请选择规格");
        }
    }

    var invalidateflag=false;
    var invalidatebuycarids='';
    <!--加载失效商品-->
    function loadinvalidategoods() {
        $.ajax({
            type:"post",
            url:'/buyCar/queryBuyCarList',
            dataType: "json",
            async:false,
            data:{isPutway:0,pageNo:pageNo,pageSize:pageSize},
            success:function(data){
                var rows = data.rows;
                if(rows!=null&&rows.length>0){
                    var html = '';
                    var h1title=$('.no-invalid-tip');
                    for(var i=0;i<rows.length;i++){
                        invalidatebuycarids+=','+rows[i].bcId;
                        html = '<div class="purchase J_product">'+
                            '<div class="checkbox" style="visibility: hidden;">'+
                            '</div>'+
                            '<a  class="img-box">';
                        var goodsPath;
                        var gdImgurl = rows[i].gdimgurl;
                        var imgUrl = rows[i].imgUrl;
                        var flag1 = gdImgurl.substr(gdImgurl.length-4)=="null";
                        if(!flag1){
                            goodsPath = gdImgurl;
                        }else{
                            goodsPath = imgUrl;
                        }
                        html += '<img data-original="'+goodsPath+'" alt="">'+
                            '<span class="invalid-bg">失效商品</span>'+
                            '</a>'+
                            '<div class="purchase-text">'+
                            '<a  class="title">'+
                            rows[i].gname+
                        '</a>'+
                        '<p class="norms J_norms">'+rows[i].bcGsval+'</p>'+
                        '<div class="price-box">'+
                            '<span class="price">￥'+
                            '<span class="J_price">'+rows[i].gdPrice+'</span>'+'/'+rows[i].gunitname+
                            '</span>'+
                            '</div>'+
                            '</div>'+
                            '</div>';
                        h1title.before(html);
                    }
                    $("img").lazyload({effect: "fadeIn"});
                    pageNo++;
                    invalidateflag = true;
                    gdloadinvalidategoods();
                }else{
                    $('.clear-all-invalid').addClass('clear-disable');
                    $('.no-invalid-tip').show();
                }
            }
        });
    }

    <!--滚动加载失效商品-->
    function gdloadinvalidategoods() {
        $(document).ready(function(){
            var range = 50;             //距下边界长度/单位px
            var totalheight = 0;
            var main = $($('.no-invalid-tip')[0]);                     //主体元素
            $(window).scroll(function(){
                var srollPos = $(window).scrollTop();    //滚动条距顶部距离(页面超出窗口的高度)

                totalheight = parseFloat($(window).height()) + parseFloat(srollPos);

                if(($(document).height()-range) <= totalheight && invalidateflag) {
                    invalidateflag = false;
                    $.ajax({
                        type:"post",
                        url:'/buyCar/queryBuyCarList',
                        dataType: "json",
                        async :false,
                        data:{isPutway:0,pageNo:pageNo,pageSize:pageSize},
                        success:function(data) {
                            var rows = data.rows;
                            if (rows != null && rows.length > 0) {
                                for (var i = 0; i < rows.length; i++) {
                                    invalidatebuycarids+=','+rows[i].bcId;
                                    var html = '';
                                    var h1title = $('.invalid-tittle-box');
                                    for (var i = 0; i < rows.length; i++) {
                                        html = '<div class="purchase J_product">' +
                                            '<div class="checkbox" style="visibility: hidden;">' +
                                            '</div>' +
                                            '<a  class="img-box">';
                                        var goodsPath;
                                        var gdImgurl = rows[i].gdimgurl;
                                        var imgUrl = rows[i].imgUrl;
                                        var flag1 = gdImgurl.substr(gdImgurl.length - 4) == "null";
                                        if (!flag1) {
                                            goodsPath = gdImgurl;
                                        } else {
                                            goodsPath = imgUrl;
                                        }
                                        html += '<img data-original="' + goodsPath + '" alt="">' +
                                            '<span class="invalid-bg">失效商品</span>' +
                                            '</a>' +
                                            '<div class="purchase-text">' +
                                            '<a  class="title">' +
                                            rows[i].gname +
                                            '</a>' +
                                            '<p class="norms J_norms">' + rows[i].bcGsval + '</p>' +
                                            '<div class="price-box">' +
                                            '<span class="price">￥' +
                                            '<span class="J_price">' + rows[i].gdPrice + '</span>' + '/' + rows[i].gunitname +
                                            '</span>' +
                                            '</div>' +
                                            '</div>' +
                                            '</div>';
                                        main.before(html);
                                    }
                                    $("img").lazyload({effect: "fadeIn"});
                                    init();
                                    pageNo++;
                                    invalidateflag = true;
                                }
                            }
                        }
                    });

                }
            });
        });
    }

    <!--删除失效购物车-->
    function deleteinvalidatebuycar() {
        if(invalidatebuycarids!=''){
            invalidatebuycarids=invalidatebuycarids.substr(1);
            $.ajax({
                type:"post",
                url:'/buyCar/deleteBuyCar',
                dataType: "json",
                async :false,
                data:{buyCarIds:invalidatebuycarids},
                success:function(data){
                    if(data.status==0){
                        window.location.href='/buyCar/gotoShoppingCar';
                    }else{
                        layer.msg(data.msg);
                    }
                }
            });
        }
    }

    <!--获取纯文本内容-->
    function removeHTMLTag(str) {
        str = str.replace(/<\/?[^>]*>/g,''); //去除HTML tag
        str = str.replace(/[ | ]*\n/g,'\n'); //去除行尾空白
        //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
        str=str.replace(/&nbsp;/ig,'');//去掉&nbsp;
        str=str.replace(/\s/g,''); //将空格去掉
        return str;
    }
    
    <!--结算-->
    function buynow() {
        var rows = $('.care-cont').find('.active');
        if(rows.length>0){
            var data = '';
            for(var i=0;i<rows.length;i++){
                data+=',{';
                var row = rows[i];
                var bcId = $(row).find('input[type=hidden]')[0].value;
                var gdId = $(row).next().val();
                var num = $(row).parent().parent().find('.J_careNum').html();
                var imgurl = $(row).parent().next().find('img')[0].src;
                var gsvals = $(row).parent().next().next().find('p').html();
                var gdprice = $(row).parent().next().next().find('div').find('.J_price').html();
                var gname = $(row).parent().next().next().find('a').html();
                var remark = $(row).next().next().val();

                data+='\'gdId\':\''+gdId+'\',';
                data+='\'num\':\''+num+'\',';
                data+='\'imgurl\':\''+imgurl+'\',';
                data+='\'gsvals\':\''+gsvals+'\',';
                data+='\'gdprice\':\''+gdprice+'\',';
                data+='\'remark\':\''+remark+'\',';
                data+='\'buyCarId\':\''+bcId+'\',';
                data+='\'gname\':\''+gname+'\'';
                data+='}';
            }
            data = data.substr(1);
            data = '['+data+']';

            data = '{data:'+data+',';

            $('#checkorderdata').val(data);
            $('#checkorderdataform').submit();
        }else{
            layer.msg('抱歉,请您选择商品');
        }
    }

</script>

<!--调用函数-->
<script>
    loadbuycardata(1);

    $(function () {
        $("img").lazyload({effect: "fadeIn"});
    });
</script>






</body>

</html>