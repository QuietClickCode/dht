<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>邀请砍价</title>
    <script src="/js/Adaptive.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/new.css">
    <style type="text/css">
        .main_ft{
            position: fixed;
            bottom: 0;
            width: 100%;
            overflow: hidden;
            color: #fff;
        }
        .main_ft .ft_item{
            width: 50%;
            float: left;
            text-align: center;
        }

        .main_ft .ft_item:first-child{
            background-color: #000;
        }

        .main_ft #askforhelp{
            height: 1.2rem;
            line-height: 1.2rem;
            font-size: 0.3rem;
            background-color: #ed5547;
            width: 100%;
        }
        .main_ft #putdown{
            height: 1.2rem;
            line-height: 1.2rem;
            font-size: 0.3rem;
            background-color: #000;
            width: 100%;
        }
        .main_ft #hasBuy{
            height: 1.2rem;
            line-height: 1.2rem;
            font-size: 0.3rem;
            background-color: #000;
            width: 100%;
        }

        .main_ft .ft_item:last-child a{
            width: 100%;
            display: block;
        }

        .item_box{
            float: left;
            width: 50%;
        }

        .item_box a{
            line-height: 1rem;
            height: 1.2rem;
            display: block;
            font-size: 0.28rem;
        }

        .item_box:last-child a{
            line-height: 1.2rem;
        }

        .item_box:first-child a{
            font-size: 0.25rem;
            padding-top: 0.4rem;
            background: url(/img/shopping.png)no-repeat center;
            background-position:center 5px;
            background-size: 0.6rem 0.6rem;

        }
    </style>
</head>

<body class="bge6">
<div class="guide-share" style="display: none;position: fixed">
    <button class="i-know" onclick="ikonw();"></button>
</div>
    <div class="specialty-title2 borderB">
        <a onclick="returnhistory();" class="icon-return"></a>
        <span>邀请砍价</span>
    </div>

    <div id="banner" class="focus">
        <div class="hd bargain">
            <ul></ul>
        </div>
        <div class="bd">
            <ul id="goodsImagesul" style="height: 200px">
                <!--<li>-->
                    <!--<img _src="img/banner1.jpg" src="img/bangain5.png" />-->
                <!--</li>-->
            </ul>
            <!-- 倒计时 -->
            <div class="product-countDown">
                活动倒计时：
                <span id="tian">00</span>
                天
                <span id="shi">00</span>
                时
                <span id="fen">00</span>
                分
                <span id="miao">00</span>
                秒
            </div>
        </div>
    </div>

    <div class="bargain-text box2">
        <div class="title" id="goodsNameDiv"><!--2017墨镜男士方形偏光眼镜大框太阳镜女潮人近视墨镜圆脸--></div>
    </div>
	
	<div class="progress_bar_box">
		<p class="p1">已砍0刀,现价:<span>￥0.00</span></p>
		<div class="progress_bar">
			<div class="progress_bar_son" style="width: 0%;"></div>
		</div>
		<p class="p2">
			<span class="span1">￥0.00</span>
			<span class="span2">￥0.00</span>
		</p>
        <input type="hidden" id="nowprice">
	</div>

    <div class="bargain-details box2">
        <div class="bargain-tab" id="J_bargainTab" style="border-bottom: 1px solid #e6e6e6;">
            <a href="#details" class="active">砍价规则</a>
            <a href="#evaluate">砍价明细</a>
        </div>

        <div class="box2">

            <div class="product-details" id="details">
				<p class="bargain_ruler">规则</p>
            </div>

            <div class="product-evaluate box2 displayN" id="evaluate">
				<ul class="bargain_info_list">
					<!--<li>-->
						<!--<img class="photo" src="img/data2.png"/>-->
						<!--<span class="name">张/三</span>-->
						<!--<span class="info">自砍了</span>-->
						<!--<span class="money">-￥320.00</span>-->
					<!--</li>-->
				</ul>
            </div>

        </div>
    </div>
	<div class="box2" style="background: #fff;margin-top: .2rem;">
        <div class="product-details" id="">
            <!-- 商品信息 -->
            <div class="like">
                <div class="cont">
                    <span class="bargain-like">商品信息</span>
                </div>
            </div>
            <div id="gdescription">

            </div>
        </div>
    </div>
    <div class="main_ft">
        <div class="ft_item" style="display: none">
            <div onclick="buynow();" class="item_box" id="buynow" style="display: none;">
                <a >立即购买</a>
            </div>
            <div class="item_box" onclick="savecutmyselflog();" id="cutmyself" style="display: none;">
                <a >自砍一刀</a>
            </div>
        </div>
        <div class="ft_item" onclick="shareGoods();" id="askforhelp">
            <a>请朋友补刀</a>
        </div>
        <div class="ft_item" id="putdown" style="width: 100%;display: none">
            <a>商品已下架</a>
        </div>
        <div class="ft_item" id="hasBuy" style="width: 100%;display: none">
            <a>您已购买该商品</a>
        </div>
    </div>

<form method="post" action="/order/getCheckOrderDataByCutPrice" style="display: none" id="checkorderdataform">
    <input type="hidden" id="gdcpId" name="gdcpId">
    <input type="hidden" id="gname" name="gname">
    <input type="hidden" id="imgurl" name="imgurl">
    <input type="hidden" id="remark" name="remark">
    <input type="hidden" id="gdprice" name="gdprice">
</form>

    <script src="/js/jquery-1.9.1.min.js"></script>
    <script src="/js/public.js"></script>
    <script src="/js/TouchSlide.1.1.js"></script>
    <script src="/js/tabs.js"></script>
    <script src="/js/layer/layer.js"></script>
    <script type="text/javascript" src="/js/jweixin-1.2.0.js"></script>
    <!--时间减少-->
    <script>
        var timestape = 0;
        function timegoing() {
            var interval = setInterval(function () {
                var date = new Date(timestape);
                var tian = Math.floor(timestape/(24*3600*1000));
                var shi = Math.floor((date.getHours()-8));
                var fen = Math.floor(date.getMinutes());
                var miao = Math.floor(date.getSeconds());
                if(tian<10){
                    $('#tian').html('0'+tian);
                }else{
                    $('#tian').html(tian);
                }
                if(shi<10){
                    $('#shi').html('0'+shi);
                }else{
                    $('#shi').html(shi);
                }
                if(fen<10){
                    $('#fen').html('0'+fen);
                }else{
                    $('#fen').html(fen);
                }
                if(miao<10){
                    $('#miao').html('0'+miao);
                }else{
                    $('#miao').html(miao);
                }

                timestape -= 1000;
                if(timestape<0){
                    clearInterval(interval);
//                $('#shi1').parent().parent().next().remove();
//                $('#shi1').parent().parent().remove();
                }
            },1000);
        }

    </script>
    <script>
        var path = window.location.pathname;
        var pathArr = path.substring(11,path.indexOf('.html')).split('~');
        var gid = parseInt(pathArr[0]);
        <!--初始化banner-->
        function initbanner() {
            TouchSlide({
                slideCell: "#banner",
                titCell: ".hd ul", //开启自动分页 autoPage:true ，此时设置 titCell 为导航元素包裹层
                mainCell: ".bd ul",
                effect: "left",
                autoPlay: true, //自动播放
                autoPage: true, //自动分页
                switchLoad: "_src" //切换加载，真实图片路径为"_src"
            });
        }

        <!--获取纯文本内容-->
        function removeHTMLTag(str) {
            str = str.replace(/<\/?[^>]*>/g,''); //去除HTML tag
            str = str.replace(/[ | ]*\n/g,'\n'); //去除行尾空白
            //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
            str=str.replace(/&nbsp;/ig,'');//去掉&nbsp;
            str=str.replace(/\s/g,''); //将空格去掉
            return str;
        }

        <!--加载商品图片-->
        function loadgoodsimage() {
            $.ajax({
                type:"post",
                url:'/goodsImage/queryGoodsImages',
                dataType: "json",
                data:{gid:gid,pageNo:1,pageSize:100},
                success:function(data){
                    var goodsImages = data.goodsImages;
                    if(goodsImages!=null&&goodsImages.length>0){
                        var html = '';
                        $('#goodsImagesul').html(html);
                        for(var i=0;i<goodsImages.length;i++){
                            html = '<li>'+
                                '<img _src="'+goodsImages[i].imgUrl+'" src="'+goodsImages[i].imgUrl+'" style="height: 200px" />'+
                                '</li>';
                            $('#goodsImagesul').append(html);
                        }
                    }
                    initbanner();
                }
            });
        }

        var cpId;
        <!--加载剩余时间-->
        function loadtimestape() {
            $.ajax({
                type:"post",
                url:'/openCutPrice/queryCutPriceListsByGid',
                dataType: "json",
                data:{gid:gid},
                success:function(data){
                    if(data.rows!=null){
                        cpId=data.rows[0].cpId;
                        <!--查询用户是否购买此商品-->
                        queryuserisbuygoods();
                        timestape = data.rows[0].timestap*1000;
                        timegoing();
                        var rule = '至少'+data.rows[0].cpLestpseson+'人砍价后方可购买此商品<br/>参与砍价人数最多为'+data.rows[0].cpMostperson+'人';
                        $('.bargain_ruler').html(rule);
                    }else{
                        nogoods();
                    }

                }
            });
        }

        <!--加载商品配置-->
        function loadgoodsconfig() {
            $.ajax({
                type:"post",
                url:'/goodsConfig/queryGoodsConfigBygid',
                dataType: "json",
                data:{gid:gid,pageNo:1,pageSize:2},
                success:function(data){
                    var goodsConfig = data.goodsConfig;
                    if(goodsConfig!=null){
                        var isPutway = goodsConfig.isPutway;
                        if(isPutway==0){
                            $('#putdown').siblings().remove();
                            $('#putdown').show();
                        }
                    }else{
                        nogoods();
                    }
                }
            });
        }

        <!--加载商品信息-->
        function loadpersonaddress() {
            $.ajax({
                type:"post",
                url:'/goods/queryGoodsById',
                dataType: "json",
                data:{gid:gid,isShow:1,isChecked:1},
                success:function(data){
                    var row = data.row;
                    if(row!=null){
                        $('#gdescription').html(row.gdescription);

                        $('#goodsNameDiv').html(row.gname);

                    }else{
                        nogoods();
                    }
                }
            });
        }

        var gdcpId;
        var remark;
        <!--加载砍价日志-->
        function loadcutpricrlog() {
            $.ajax({
                type:"post",
                url:'/openCutPriceLog/queryCutPriceLog',
                dataType: "json",
                data:{gid:gid},
                success:function(data){
                    var rows = data.rows;
                    if(rows!=null&&rows.length>0){
                        var times = 0;
                        var gdPrice = parseFloat(rows[0].gdPrice/100).toFixed(2) ;
                        var cpPrice = parseFloat(rows[0].cpPrice/100).toFixed(2) ;
                        var cpMostperson = rows[0].cpMostperson;
                        var cpLestperson = rows[0].cpLestperson;
                        gdcpId = rows[0].gdcpId;
                        remark = rows[0].remark;
                        var logul = $('.bargain_info_list');
                        logul.html('');
                        var cpindex= parseFloat(0.00);
                        if(rows[0].usdId!=null){
                            times = rows.length;
                            var flag = false;
                            for(var i=0;i<rows.length;i++){
                                var html = '<li>' +
                                    '<img class="photo" src="'+rows[i].uimgurl+'"/>' +
                                    '<span class="name">'+rows[i].uname+'</span>';
                                var usId = rows[i].usId;
                                var usdId = rows[i].usdId;
                                var cplCutdownprice = parseFloat(rows[i].cplCutdownprice/100).toFixed(2);
                                cpindex += Number(parseFloat(cplCutdownprice).toFixed(2));
                                var howcp='';
                                if(usId==usdId){
                                    howcp='自砍';
                                    flag=true;
                                }else{
                                    howcp='帮砍';
                                }
                                html += '<span class="info">'+howcp+'</span>' +
                                    '<span class="money">-￥'+cplCutdownprice+'</span>' +
                                    '</li>';
                                logul.append(html);
                            }
                            if(cpLestperson<=rows.length){
                                $('#askforhelp').css('width','50%');
                                $('#askforhelp').prev().show();
                                $('#buynow').show();
                            }
                            if(cpMostperson<=rows.length){
                                $('#cutmyself').siblings().css('width','100%');
                                $('#cutmyself').remove();
                            }
                        }


                        var nowprice = gdPrice-cpindex;
                        $('.p1').html('已砍'+times+'刀，现价，<span>￥'+nowprice+'</span>');
                        $('#nowprice').val(nowprice);
                        $('.span1').html('￥'+gdPrice);
                        $('.span2').html('￥'+cpPrice);
                        $('.progress_bar_son').css('width',times/cpMostperson*100+'%');
                        if(flag){
                            $('#cutmyself').siblings().css('width','100%');
                            $('#cutmyself').remove();
                            // $('#askforhelp').css('width','100%');
                        }else{
                            if(cpLestperson>rows.length){
                                $('#cutmyself').css('width','100%');
                            }else{
                                $('#cutmyself').css('width','50%');
                            }
                            $('#askforhelp').css('width','50%');
                            $('#cutmyself').parent().show();
                            $('#cutmyself').show();
                            // $('#askforhelp').css('width','50%');
                        }
                        if(cpLestperson>rows.length&&flag){
                            $('#buynow').parent().hide();
                            $('#askforhelp').css('width','100%');
                        }
                    }else{

                    }
                }
            });
        }

        <!--自砍一刀-->
        function savecutmyselflog() {
            $.ajax({
                type:"post",
                url:'/openCutPriceLog/saveCutPriceLog',
                dataType: "json",
                async :false,
                data:{gid:gid},
                success:function(data){
                    if(data.status==3){
                        layer.msg('请登录');
                    }else{
                        $('#cutmyself').parent().hide();
                        $('#askforhelp').css('width','100%');
                        layer.msg('成功自砍一刀');
                        setTimeout(function () {
                            window.location.reload();
                        },1000);
                    }
                }
            });
        }

        <!--查询用户是否购买此商品-->
        function queryuserisbuygoods() {
            $.ajax({
                type:"post",
                url:"/goodsIsbuycp/querygoodsIsbuycp",
                dataType: "json",
                data:{cpId:cpId},
                success:function(data){
                    var row = data.row;
                    if(row!=null){
                        $('#hasBuy').siblings().remove();
                        $('#hasBuy').show();
                    }
                }
            });
        }

        <!--调用分享函数-->
        function shareGoods() {
            $('.bge6').css('overflow', 'hidden');
            $('.guide-share').fadeIn('slow');
        }
        <!--点击知道了-->
        function ikonw() {
            $('.bge6').css('overflow', 'auto');
            $('.guide-share').fadeOut('slow');
        }

        <!--商品不存在 跳转页面-->
        function nogoods() {
            window.location.href='/home/lostHtml';
        }

        <!--返回上一页-->
        function returnhistory() {
            if(document.referrer===''){
                window.location.href='/';
            }else{
                window.history.go(-2);
            }
        }

        <!--立即购买-->
        function buynow() {
            $('#imgurl').val($('#goodsImagesul').find('img')[0].src);
            $('#gname').val($('#goodsNameDiv').html());
            $('#gdcpId').val(gdcpId);
            $('#remark').val(remark);
            $('#gdprice').val($('#nowprice').val());

            $('#checkorderdataform').submit();
        }
    </script>

    <!--调用函数-->
    <script>
        <!--加载商品图片-->
        loadgoodsimage();

        <!--加载剩余时间-->
        loadtimestape();
        <!--商品下架-->
        loadgoodsconfig();

        <!--加载商品信息-->
        loadpersonaddress();

        <!--加载砍价日志-->
        loadcutpricrlog();
    </script>
    <script>
        var homePath;
        <!--初始化分享-->
        function initShare() {
            $.ajax({
                type:"post",
                url:'/wxShare/createWxShare',
                dataType: "json",
                async :false,
                data:{path:path},
                success:function(data){
                    if(data!=null){
                        homePath = data.homePath;
//                        alert(homePath);
                        var appId = data.appid;
                        var timestamp = data.timestamp;
                        var nonceStr = data.nonceStr;
                        var signature = data.signature;
                        wx.config({

                            debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。

                            appId: appId, // 必填，公众号的唯一标识

                            timestamp: timestamp, // 必填，生成签名的时间戳

                            nonceStr: nonceStr, // 必填，生成签名的随机串

                            signature: signature,// 必填，签名，见附录1

                            jsApiList: ['onMenuShareTimeline',
                                'onMenuShareAppMessage',
                                'onMenuShareQQ',
                                'onMenuShareWeibo',
                                'onMenuShareQZone'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2

                        });

                    }

                }
            });
        }

        <!--调用初始化分享-->
        initShare();

        wx.ready(function(){
            var imgUrl = $('#goodsImagesul').find('img')[0].src;
//            alert(imgUrl);
            var title = $('#goodsNameDiv').html();
            var link = homePath;
            var desc = removeHTMLTag($('#gdescription').html());
            //share to timeline
            // 获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
            wx.onMenuShareTimeline({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link:link,
                imgUrl: imgUrl, // 分享图标
                success: function (res) {
                    //alert('朋友圈');

                    saveShareRecord('朋友圈',title);
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
            // 获取“分享给朋友”按钮点击状态及自定义分享内容接口
            wx.onMenuShareAppMessage({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link:link,
                imgUrl: imgUrl, // 分享图标
                success: function (res) {
                    //alert('好友');
//                    alert(title);
                    saveShareRecord('好友',title);
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
            // 获取“分享到QQ”按钮点击状态及自定义分享内容接口
            wx.onMenuShareQQ({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link:link,
                imgUrl: imgUrl, // 分享图标
                success: function (res) {
                    saveShareRecord('QQ',title);
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
            // 获取“分享到微博”按钮点击状态及自定义分享内容接口
            wx.onMenuShareWeibo({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link:link,
                imgUrl: imgUrl, // 分享图标
                success: function (res) {
                    saveShareRecord('微博',title);
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
            // 获取“分享到QQ空间”按钮点击状态及自定义分享内容接口
            wx.onMenuShareQZone({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link:link,
                imgUrl: imgUrl, // 分享图标
                success: function (res) {
                    saveShareRecord('QQ空间',title);
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
        });

        <!--记录分享-->
        function saveShareRecord(usWhere,usWhat) {
            $.ajax({
                type:"post",
                url:'/userShare/saveUserShare',
                dataType: "json",
                async :false,
                data:{usWhere:usWhere,usWhat:usWhat},
                success:function(data){
                }
            });
        }
    </script>
</body>

</html>